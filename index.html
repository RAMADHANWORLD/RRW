<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramadhan World App - Prayer Times, Qibla, Quran</title>
    <meta name="description" content="An all-in-one Islamic app featuring accurate prayer times, Sehri and Iftar times, Qibla compass, Quran recitation, a dynamic Islamic calendar, Naat collection, and Tasbeeh counter. Your perfect companion for Ramadan and daily worship.">
    <meta name="keywords" content="islamic app, prayer times, qibla direction, quran online, ramadan 2025, sehri time, iftar time, islamic calendar, hijri date, naat, tasbeeb counter, ramadhan world, islamic history, salah times, listen quran, hadith, dua">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .font-amiri {
            font-family: 'Amiri', serif;
        }
        h1, h2, h3, h4 {
            color: white;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
        }
        .card {
            background-color: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .prayer-time.active {
            background-color: rgba(50, 230, 0, 0.25);
            border-left-width: 4px;
            border-color: #32e600;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .nav-button.active, .action-btn {
            background-color: #32e600;
            color: white;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
            box-shadow: 0 0 15px rgba(50, 230, 0, 0.5);
            border-radius: 9999px;
        }
         .action-btn {
            border: none;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 0.75rem;
            max-width: 960px;
            margin: auto;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #compass {
            position: relative;
            width: 256px;
            height: 256px;
            background-color: #1f2937;
            border-radius: 9999px;
            border: 4px solid #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2rem auto;
        }
        .direction {
            position: absolute;
            font-weight: bold;
            color: #9ca3af;
        }
        .direction.north { top: 10px; font-size: 1.5rem; color: #ef4444; }
        .direction.south { bottom: 10px; }
        .direction.east { right: 10px; }
        .direction.west { left: 10px; }
        #qibla-line {
            position: absolute;
            width: 3px;
            height: 128px;
            background-color: #32e600;
            top: 0;
            left: 50%;
            transform-origin: bottom center;
            transition: transform 0.2s linear;
            box-shadow: 0 0 10px rgba(50, 230, 0, 0.7);
            z-index: 5;
        }
        .section-card {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 48rem;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        .section-title {
            font-family: 'Cairo', sans-serif;
            font-size: 1.875rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(50, 230, 0, 0.7);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.25rem;
        }
        .calendar-item {
            background-color: rgba(50, 230, 0, 0.1);
            border: 1px solid rgba(50, 230, 0, 0.2);
            border-radius: 0.75rem;
            padding: 1.25rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
        }
        .calendar-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
        }
        .calendar-date {
            font-family: 'Amiri', serif;
            font-size: 1.25rem;
            background-color: #32e600;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            display: inline-block;
            margin-bottom: 0.75rem;
        }
        .calendar-event-name {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .calendar-event-desc {
            font-size: 1rem;
            color: #d1d5db;
            flex-grow: 1;
        }
        .gregorian-date {
            font-size: 0.9rem;
            color: #9ca3af;
            margin-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 0.75rem;
        }
        #inbox-list {
            max-height: 70vh;
            overflow-y: auto;
        }
        .inbox-item {
            background-color: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #32e600;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 0 0.5rem 0.5rem 0;
        }
        .inbox-item.history {
            border-left-color: #f59e0b; /* Amber */
        }
        .inbox-item .timestamp {
            font-size: 0.8rem;
            color: #9ca3af;
        }
        .text-neon { color: #32e600; }
        .hover-bg-neon:hover { 
            background-color: #32e600; 
            color: white; 
            font-weight: 700; 
            text-shadow: 0 0 10px rgba(255,255,255,0.7); 
            box-shadow: 0 0 15px rgba(50, 230, 0, 0.5); 
        }
        #countdown-timer {
            font-family: 'Amiri', serif;
            font-size: 4.5rem; 
            font-weight: 700; 
            letter-spacing: 0.05em;
            padding: 0.5rem 0;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8), 0 0 20px #32e600, 0 0 35px #32e600, 0 0 50px #32e600, 0 0 70px #32e600;
        }
        #home-radio-section .card {
            box-shadow: 0 0 15px rgba(50, 230, 0, 0.4), 0 0 25px rgba(50, 230, 0, 0.2);
            border-color: rgba(50, 230, 0, 0.5);
        }
        #hadith-content p, #hadith-reference {
            font-size: 1.125rem;
            line-height: 1.75;
            color: #d1d5db;
        }
        #hadith-reference { color: #32e600; font-weight: 600; margin-top: 1rem; }
        .dua-form label {
            font-weight: 600; display: block; margin-top: 1rem; margin-bottom: 0.5rem; text-align: left;
        }
        .dua-form input, .dua-form textarea {
            width: 100%; background-color: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            padding: 0.75rem; border-radius: 0.5rem; color: white;
        }
        .dua-list {
            margin-top: 1.5rem; max-height: 400px; overflow-y: auto; padding-right: 10px;
        }
        .dua-item {
            background-color: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.75rem; margin-bottom: 1rem;
            border-left: 4px solid #32e600; text-align: left;
        }
        .dua-item small { color: #9ca3af; font-size: 0.8rem; }
        
        audio::-webkit-media-controls-panel { background-color: #374151; }
        audio::-webkit-media-controls-play-button,
        audio::-webkit-media-controls-current-time-display,
        audio::-webkit-media-controls-time-remaining-display,
        audio::-webkit-media-controls-mute-button { color: #32e600; border-radius: 9999px; }
        audio::-webkit-media-controls-timeline,
        audio::-webkit-media-controls-volume-slider { background-color: rgba(50, 230, 0, 0.2); border-radius: 9999px; margin: 0 10px; }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="loading-screen" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col justify-center items-center z-50 transition-opacity duration-500">
        <h1 class="text-5xl font-amiri text-white" style="text-shadow: 0 0 15px rgba(50, 230, 0, 0.5);">RAMADHAN WORLD</h1>
    </div>

    <div id="main-content" class="min-h-screen container mx-auto p-4 sm:p-6 lg:p-8 opacity-0 transition-opacity duration-1000">
        <!-- Header Section -->
        <header class="text-center mb-6">
            <img id="app-logo" src="https://i.ibb.co/Zp0bgjsS/ART-WORKS-1.png" alt="Ramadhan World Logo" class="w-[200px] h-[200px] mx-auto mb-4 rounded-full shadow-lg object-contain">
            <h1 class="text-4xl sm:text-5xl">Ramadhan World</h1>
            <p id="islamic-date" class="text-lg text-gray-300 mt-2">Loading Islamic Date...</p>
            <div id="location-area">
                <p id="location" class="text-md text-gray-400 mt-1">Location not set. Using default times.</p>
                <button id="find-location-btn" class="action-btn px-4 py-2 mt-2 text-sm" onclick="startLocationSearch()">Enable Location for Prayer Times</button>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="flex justify-center gap-2 mb-6 flex-wrap items-center">
            <button onclick="showView('home')" class="nav-button active px-4 py-2 rounded-lg bg-gray-700 transition">Home</button>
            <button onclick="showView('salah')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Salah</button>
            <button onclick="showView('listenQuran')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Quran</button>
            <button onclick="showView('dua')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Request a Dua</button>
            <button onclick="showView('tasbeeh')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Tasbeeh</button>
            <button onclick="showView('naat')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Naat</button>
            <button onclick="showView('qibla')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Qibla</button>
            <button onclick="showView('calendar')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Calendar</button>
            <button onclick="showView('inbox')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Inbox</button>
            <button onclick="showView('settings')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Settings</button>
        </nav>

        <!-- Main Views -->
        <main>
            <!-- Home View -->
            <div id="home-view">
                <section id="countdown-section" class="mb-8">
                    <div class="card rounded-2xl p-6 max-w-2xl mx-auto text-center">
                        <h2 class="text-2xl mb-2">Time until <span id="next-prayer-name" class="text-neon">...</span></h2>
                        <div id="countdown-timer" class="text-neon">00:00:00</div>
                    </div>
                </section>
                
                <section id="home-radio-section" class="mb-8">
                    <div class="card rounded-2xl p-6 max-w-2xl mx-auto text-center">
                        <h2 class="section-title" style="font-size: 1.5rem; margin-bottom: 1rem;">üìª PRESS TO PLAY LIVE RADIO</h2>
                        <audio id="radioPlayer" controls controlslist="nodownload" class="w-full rounded-lg" preload="auto">
                            <source src="https://ramadhan786.radioca.st/;" type="audio/mpeg" />
                        </audio>
                    </div>
                </section>

                <section id="hadith-section" class="mb-8">
                    <div class="section-card">
                        <h2 class="section-title">üìú Today's Hadith</h2>
                        <div id="hadith-content" class="text-center">
                            <p class="font-amiri text-lg">Loading a Hadith...</p>
                            <p id="hadith-reference" class="text-neon mt-4 font-semibold"></p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Salah View -->
            <div id="salah-view" class="hidden">
                <div class="card rounded-2xl p-6 max-w-2xl mx-auto">
                    <h2 class="text-2xl mb-4 text-center">Today's Times</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div id="salah-fajr" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Fajr</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-sunrise" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Sunrise</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-dhuhr" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Dhuhr</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-asr" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Asr</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-maghrib" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Maghrib</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-isha" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Isha</span><span class="text-xl font-mono">--:--</span></div>
                    </div>
                    <hr class="border-gray-600 my-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                        <div id="salah-sehri" class="card rounded-xl p-4 flex justify-between items-center border-l-4" style="background-color: rgba(50, 230, 0, 0.2); border-color: #32e600;">
                            <span class="font-semibold text-lg">Sehri End</span>
                            <span class="text-xl font-mono">--:--</span>
                        </div>
                        <div id="salah-iftar" class="card rounded-xl p-4 flex justify-between items-center bg-yellow-800 border-l-4 border-yellow-400">
                            <span class="font-semibold text-lg">Iftar</span>
                            <span class="text-xl font-mono">--:--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Listen Quran View -->
            <div id="listen-quran-view" class="hidden">
                 <div class="card rounded-2xl p-6 max-w-4xl mx-auto">
                    <h2 class="text-2xl mb-4 text-center">Holy Quran Recitation</h2>
                    <p class="text-center text-gray-400 mb-4">Recitation by Abdurrahman As-Sudais</p>
                    <div id="quran-player" class="text-center hidden">
                        <h3 id="current-surah-name" class="text-xl mb-2 text-neon"></h3>
                        <audio id="quran-audio-player" controls controlslist="nodownload" class="w-full rounded-lg"></audio>
                    </div>
                    <div id="quran-loading-indicator" class="text-center py-8 hidden">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-neon mx-auto"></div>
                        <p class="mt-4 text-lg">Loading Surahs...</p>
                    </div>
                    <div id="quran-surah-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto pr-2"></div>
                </div>
            </div>

            <!-- Dua View -->
            <div id="dua-view" class="hidden">
                <div class="section-card">
                    <h2 class="section-title">ü§≤ Request a Dua</h2>
                     <form id="dua-form" class="dua-form">
                        <label for="dua-name">Name for Dua</label>
                        <input type="text" id="dua-name" placeholder="e.g., My Father" required>
                        
                        <label for="dua-relation">Your Relation</label>
                        <input type="text" id="dua-relation" placeholder="e.g., Son" required>
                        
                        <label for="dua-text">Write your Dua</label>
                        <textarea id="dua-text" rows="4" placeholder="May Allah grant him peace and good health..." required></textarea>
                        
                        <button type="submit" class="action-btn w-full mt-6 py-3">Submit Dua</button>
                    </form>
                    <div class="dua-list mt-6">
                        <h3 class="text-xl text-center mb-4 border-b border-gray-700 pb-2">Community Dua List</h3>
                        <div id="dua-list-container"></div>
                    </div>
                </div>
            </div>
            
            <!-- Tasbeeh View -->
            <div id="tasbeeh-view" class="hidden">
                 <div class="card rounded-2xl p-6 max-w-sm mx-auto text-center">
                    <h2 class="text-2xl mb-4">Tasbeeh Counter</h2>
                    <div id="tasbeeh-counter-display" class="font-mono text-7xl font-bold text-neon mb-4">0</div>
                    <button onclick="incrementTasbeeh()" class="w-48 h-48 rounded-full bg-neon text-white text-5xl flex items-center justify-center mx-auto shadow-lg transform transition hover:scale-105 active:scale-95" style="box-shadow: 0 0 20px rgba(50, 230, 0, 0.6);"><i class="fas fa-plus"></i></button>
                    <button onclick="resetTasbeeh()" class="mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition">Reset</button>
                </div>
            </div>
            
            <!-- Naat View -->
            <div id="naat-view" class="hidden">
                <div class="card rounded-2xl p-6 mx-auto text-center">
                    <h2 class="text-2xl mb-4">Naat Collection</h2>
                    <div class="video-container mb-4">
                        <div id="youtube-player"></div>
                    </div>
                    <div class="flex justify-center gap-4 flex-wrap">
                        <button onclick="previousVideo()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full text-lg"><i class="fas fa-backward"></i></button>
                        <button id="tv-play-button" onclick="playVideo()" class="bg-neon py-2 px-4 rounded-full text-lg"><i class="fas fa-play"></i></button>
                        <button id="tv-pause-button" onclick="pauseVideo()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full text-lg hidden"><i class="fas fa-pause"></i></button>
                        <button onclick="nextVideo()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full text-lg"><i class="fas fa-forward"></i></button>
                    </div>
                </div>
            </div>

            <!-- Qibla View -->
            <div id="qibla-view" class="hidden text-center">
                 <div class="card rounded-2xl p-6 max-w-sm mx-auto">
                    <h2 class="text-2xl mb-4">Qibla Compass</h2>
                    <div id="compass">
                        <div class="direction north">N</div>
                        <div class="direction south">S</div>
                        <div class="direction east">E</div>
                        <div class="direction west">W</div>
                        <div id="qibla-line"></div>
                    </div>
                    <p id="qibla-direction" class="mt-4 text-lg text-gray-300">For accurate results, hold your device flat, away from any metals.</p>
                    <p class="text-sm text-gray-400 mt-2">(Accuracy depends on your device's hardware and browser support)</p>
                </div>
            </div>

            <!-- Calendar View -->
            <div id="calendar-view" class="hidden">
                <section id="islamic-calendar-section">
                     <div class="section-card">
                        <h2 class="section-title">üóìÔ∏è Major Islamic Events</h2>
                        <div id="calendar-loading-indicator" class="text-center py-8">
                            <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-neon mx-auto"></div>
                            <p class="mt-4 text-lg">Fetching live dates...</p>
                        </div>
                        <div id="islamic-calendar-grid" class="calendar-grid">
                            <!-- Events will be populated here by JavaScript -->
                        </div>
                    </div>
                </section>
            </div>

            <!-- Inbox View -->
            <div id="inbox-view" class="hidden">
                <div class="section-card">
                    <h2 class="section-title">üì• Inbox</h2>
                    <div id="inbox-list">
                        <p class="text-center text-gray-400">No notifications yet.</p>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="hidden">
                <div class="card rounded-2xl p-6 max-w-lg mx-auto">
                    <h2 class="text-2xl mb-4">Settings</h2>
                    <div class="space-y-4">
                        <div>
                            <h3 class="text-lg mb-2">Master Notification Control</h3>
                            <button id="settings-notification-toggle" onclick="toggleMasterNotifications()" class="w-full py-2 px-4 rounded-lg transition-colors">Toggle Notifications</button>
                        </div>
                        <hr class="border-gray-600">
                        <div>
                            <h3 class="text-lg mb-2">Manage Inbox</h3>
                             <button onclick="clearInboxHistory()" class="w-full py-2 px-4 rounded-lg bg-red-600 hover:bg-red-700 transition-colors">Clear Inbox History</button>
                        </div>
                    </div>
                    <button onclick="saveSettings()" class="mt-6 w-full action-btn py-3 rounded-lg transition">Save Settings</button>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>Contact us: radioramadhanworld@gmail.com</p>
            <p>Powered by RAMADHAN WORLD PRODUCTION</p>
        </footer>
    </div>

    <audio id="azan-fajr-audio" src="fajr.mp3" preload="auto"></audio>
    <audio id="azan-other-audio" src="other salah.mp3" preload="auto"></audio>
    <!-- Removed sms-tune-audio as its base64 source was invalid -->
    <div id="settings-saved-message" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50"></div>
    
    <!-- Correct YouTube Iframe API URL -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // --- DOM Elements & State ---
        const loadingScreen = document.getElementById('loading-screen');
        const mainContent = document.getElementById('main-content');
        const islamicDateEl = document.getElementById('islamic-date');
        const locationEl = document.getElementById('location');
        const nextPrayerNameEl = document.getElementById('next-prayer-name');
        const countdownTimerEl = document.getElementById('countdown-timer');
        const salahPrayerTimeElements = { Fajr: document.querySelector('#salah-fajr span:last-child'), Sunrise: document.querySelector('#salah-sunrise span:last-child'), Dhuhr: document.querySelector('#salah-dhuhr span:last-child'), Asr: document.querySelector('#salah-asr span:last-child'), Maghrib: document.querySelector('#salah-maghrib span:last-child'), Isha: document.querySelector('#salah-isha span:last-child') };
        const views = { home: document.getElementById('home-view'), salah: document.getElementById('salah-view'), listenQuran: document.getElementById('listen-quran-view'), dua: document.getElementById('dua-view'), qibla: document.getElementById('qibla-view'), tasbeeh: document.getElementById('tasbeeh-view'), naat: document.getElementById('naat-view'), calendar: document.getElementById('calendar-view'), inbox: document.getElementById('inbox-view'), settings: document.getElementById('settings-view') };
        const qiblaDirectionEl = document.getElementById('qibla-direction');
        const qiblaLine = document.getElementById('qibla-line');
        const radioPlayer = document.getElementById('radioPlayer');
        const azanFajrAudio = document.getElementById('azan-fajr-audio');
        const azanOtherAudio = document.getElementById('azan-other-audio');
        // const smsTuneAudio = document.getElementById('sms-tune-audio'); // Removed as the source was invalid
        const settingsSavedMessage = document.getElementById('settings-saved-message');
        const tvPlayButton = document.getElementById('tv-play-button');
        const tvPauseButton = document.getElementById('tv-pause-button');
        const tasbeehCounterDisplay = document.getElementById('tasbeeh-counter-display');
        const settingsNotificationToggle = document.getElementById('settings-notification-toggle');
        const inboxList = document.getElementById('inbox-list');
        const hadithContentEl = document.getElementById('hadith-content');
        const quranSurahList = document.getElementById('quran-surah-list');
        const quranLoadingIndicator = document.getElementById('quran-loading-indicator');
        const quranPlayer = document.getElementById('quran-player');
        const quranAudioPlayer = document.getElementById('quran-audio-player');
        const currentSurahName = document.getElementById('current-surah-name');
        const duaListContainer = document.getElementById('dua-list-container');
        const duaForm = document.getElementById('dua-form');

        let tasbeehCount = 0;
        let countdownInterval;
        let qiblaAngle = 0;
        let settings = {};
        let notificationsEnabled = true;
        let youtubePlayer;
        let userCoords = null;
        let notificationLog = [];
        let intendedAudioSource = null;
        let quranChapters = [];
        let quranListLoaded = false;
        let duaList = [];
        let currentPlayingQuran = { element: null, surahId: null, index: -1 };

        const NOTIFICATION_STATUS_KEY = 'ramadanAppNotificationStatus';
        const NOTIFICATION_LOG_KEY = 'ramadanAppNotificationLog';
        const HADITH_CACHE_KEY = 'ramadanAppHadithCache';
        const DUA_LIST_KEY = 'ramadanAppDuaList';
        
        const islamicEvents = [
            { hijriDate: '01-01', date: "1 Muharram", name: "Islamic New Year", description: "The start of the Islamic lunar calendar." },
            { hijriDate: '10-01', date: "10 Muharram", name: "Day of Ashura", description: "A day of fasting and remembrance." },
            { hijriDate: '12-03', date: "12 Rabi al-Awwal", name: "Mawlid an-Nabi", description: "The birthday of Prophet Muhammad Ô∑∫." },
            { hijriDate: '27-07', date: "27 Rajab", name: "Isra and Mi'raj", description: "The Prophet's Ô∑∫ miraculous night journey." },
            { hijriDate: '15-08', date: "15 Sha‚Äôban", name: "Laylat al-Bara'at", description: "The night of forgiveness." },
            { hijriDate: '01-09', date: "1 Ramadan", name: "Start of Ramadan", description: "The beginning of the holy month of fasting." },
            { hijriDate: '27-09', date: "27 Ramadan", name: "Laylat al-Qadr", description: "The Night of Power, better than a thousand months." },
            { hijriDate: '01-10', date: "1 Shawwal", name: "Eid al-Fitr", description: "The festival of breaking the fast." },
            { hijriDate: '09-12', date: "9 Dhul Hijjah", name: "Day of Arafah", description: "The pinnacle of the annual Hajj pilgrimage." },
            { hijriDate: '10-12', date: "10 Dhul Hijjah", name: "Eid al-Adha", description: "The festival of sacrifice." }
        ];

        /**
         * Manages audio playback across different sections (radio, quran, naat)
         * to ensure only one audio source plays at a time.
         * @param {string|null} source - The source that is intended to play ('radio', 'quran', 'naat'), or null to pause all.
         */
        function manageAudioPlayback(source) {
            if (source !== 'radio' && radioPlayer && !radioPlayer.paused) { radioPlayer.pause(); }
            if (source !== 'quran' && quranAudioPlayer && !quranAudioPlayer.paused) { quranAudioPlayer.pause(); }
            // Check if youtubePlayer exists and has pauseVideo method before calling
            if (source !== 'naat' && youtubePlayer && typeof youtubePlayer.pauseVideo === 'function' && youtubePlayer.getPlayerState() === 1) { youtubePlayer.pauseVideo(); }
            intendedAudioSource = source;
        }

        /**
         * Initializes the application by hiding the loading screen,
         * loading settings, and fetching initial data.
         */
        async function initializeApp() {
            // Show branding screen for a moment then reveal the app
            setTimeout(hideLoading, 1500);
            
            // Load all non-location-dependent settings and stored data
            loadSettings();
            loadNotificationStatus();
            loadNotificationLog();
            displayNotificationsInInbox();
            loadTasbeehCount();
            loadDuas();
            setupRadioPlayer();
            
            // Fetch Hadith
            await fetchHadith();
            
            // Set default prayer times until user enables location
            // This ensures some data is displayed even without location access.
            const defaultPrayerData = await getPrayerTimes("Karachi", "Pakistan");
            if(defaultPrayerData) updateCountdown(defaultPrayerData.timings);
        }

        /**
         * Fetches a random Hadith from an external API or loads from cache.
         * Caches Hadith for 6 hours to reduce API calls.
         */
        async function fetchHadith() {
            try {
                const cachedData = JSON.parse(localStorage.getItem(HADITH_CACHE_KEY));
                const sixHours = 6 * 60 * 60 * 1000; // 6 hours in milliseconds
                // Use cached data if available and not older than 6 hours
                if (cachedData && (Date.now() - cachedData.timestamp < sixHours)) {
                    displayHadith(cachedData.hadith);
                    return;
                }
                const response = await fetch("https://random-hadith-generator.vercel.app/bukhari/");
                if (!response.ok) throw new Error('Failed to fetch Hadith');
                const data = await response.json();
                const hadith = data.data;
                displayHadith(hadith);
                // Cache the fetched Hadith with a timestamp
                localStorage.setItem(HADITH_CACHE_KEY, JSON.stringify({ hadith: hadith, timestamp: Date.now() }));
            } catch (error) {
                console.error("Hadith fetch error:", error);
                // Fallback Hadith in case of API failure
                const fallbackHadith = { hadith_english: "The best among you are those who have the best manners and character.", book: "Sahih al-Bukhari", refno: "3559" };
                displayHadith(fallbackHadith);
            }
        }
        
        /**
         * Displays the fetched Hadith in the UI.
         * @param {object} hadith - The Hadith object containing text and reference.
         */
        function displayHadith(hadith) {
            hadithContentEl.innerHTML = `<p class="font-amiri text-lg">${escapeHTML(hadith.hadith_english)}</p><p id="hadith-reference" class="text-neon mt-4 font-semibold">Reference: ${escapeHTML(hadith.book)} ${escapeHTML(hadith.refno)}</p>`;
        }
        
        /**
         * Populates the Islamic calendar grid with major Islamic events.
         * Fetches Gregorian dates for Hijri events from an API.
         * @param {number} hijriYear - The current Hijri year to fetch events for.
         */
        async function populateEventCalendar(hijriYear) {
            const grid = document.getElementById('islamic-calendar-grid');
            const loadingIndicator = document.getElementById('calendar-loading-indicator');
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today's date for comparison

            // Create an array of API calls for each Islamic event
            const apiCalls = islamicEvents.map(event => 
                fetch(`https://api.aladhan.com/v1/hToG?date=${event.hijriDate}-${hijriYear}`)
                    .then(res => res.json())
            );

            try {
                const results = await Promise.all(apiCalls);
                const eventsHtml = results.map((result, index) => {
                    if (result.code === 200 && result.data) {
                        const gregDate = result.data.gregorian;
                        // Construct a Date object from the Gregorian date to compare with today
                        const eventDate = new Date(`${gregDate.month.en} ${gregDate.day}, ${gregDate.year}`);
                        
                        // Only display events that are today or in the future
                        if (eventDate >= today) {
                            const fullDisplayDate = eventDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                            return `<div class="calendar-item">
                                        <div class="calendar-date">${islamicEvents[index].date}</div>
                                        <h3 class="calendar-event-name">${escapeHTML(islamicEvents[index].name)}</h3>
                                        <p class="calendar-event-desc">${escapeHTML(islamicEvents[index].description)}</p>
                                        <div class="gregorian-date"><strong>Expected Gregorian Date (${gregDate.year}):</strong><br>${fullDisplayDate}</div>
                                    </div>`;
                        }
                    }
                    return ''; // Return empty string for past events or failed API calls
                }).join('');

                // Update the grid with events or a message if no upcoming events
                grid.innerHTML = eventsHtml.trim() ? eventsHtml : `<p class="text-center text-gray-400 col-span-full">No upcoming major events found.</p>`;
                loadingIndicator.style.display = 'none'; // Hide loading indicator
            } catch (error) {
                console.error("Error fetching calendar events:", error);
                loadingIndicator.innerHTML = `<p class="text-red-400">Could not load live calendar dates. Please try again later.</p>`;
            }
        }
        
        /**
         * Calculates the Qibla direction (angle from North) based on user's coordinates.
         * @param {number} userLat - User's latitude.
         * @param {number} userLon - User's longitude.
         * @returns {number} The Qibla angle in degrees (0-360).
         */
        function calculateQiblaDirection(userLat, userLon) {
            const kaabaLat = 21.4225, kaabaLon = 39.8262; // Kaaba coordinates
            const dLon = (kaabaLon - userLon) * (Math.PI / 180); // Difference in longitude, converted to radians
            const lat1 = userLat * (Math.PI / 180), lat2 = kaabaLat * (Math.PI / 180); // User and Kaaba latitudes, converted to radians

            const y = Math.sin(dLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);

            // Calculate angle and convert to degrees, ensuring it's positive (0-360)
            return (Math.atan2(y, x) * (180 / Math.PI) + 360) % 360;
        }
        
        /**
         * Initiates the location search process, first attempting geolocation, then IP fallback.
         */
        function startLocationSearch() {
            const findBtn = document.getElementById('find-location-btn');
            if (findBtn) findBtn.style.display = 'none'; // Hide the button once search starts
            locationEl.textContent = 'Fetching your location...';
            getUserLocation();
        }

        /**
         * Attempts to get user's location via IP address if geolocation fails or is unavailable.
         */
        async function getLocationByIp() {
            locationEl.textContent = "Estimating location from network...";
            try {
                // Using freeipapi.com for IP-based geolocation
                const response = await fetch('https://freeipapi.com/api/json/');
                if (!response.ok) {
                    // Log more details about the failed response
                    console.error(`IP API response not OK: ${response.status} ${response.statusText}`);
                    throw new Error(`Failed to fetch location data (Status: ${response.status})`);
                }
                const data = await response.json();
                if (data.cityName && data.countryName) {
                    const { cityName: city, countryName: country } = data;
                    locationEl.textContent = `${city}, ${country}`;
                    const prayerData = await getPrayerTimes(city, country);
                    if (prayerData) updateCountdown(prayerData.timings);
                } else {
                    // Log the unexpected data structure
                    console.error('IP API returned unexpected data structure:', data);
                    throw new Error('IP API returned unexpected data.');
                }
            } catch (error) {
                console.error("IP Geolocation failed:", error);
                // Provide a more informative message to the user
                locationEl.textContent = "Could not determine location automatically. Please check your internet connection or try again. Using default (Karachi, Pakistan).";
                showTemporaryMessage("Automatic location failed. Check internet. Using default times.", true);
                // Fallback to a hardcoded default if IP API fails
                const prayerData = await getPrayerTimes("Karachi", "Pakistan");
                if (prayerData) updateCountdown(prayerData.timings);
            }
        }

        /**
         * Gets user's precise location using Geolocation API. Falls back to IP if denied or error.
         */
        function getUserLocation() {
            // Note: For geolocation to work on iOS (and securely on other browsers), the app MUST be served over HTTPS.
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    // Geolocation not supported, fall back to IP-based location
                    getLocationByIp().then(resolve);
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        userCoords = { latitude: position.coords.latitude, longitude: position.coords.longitude };
                        qiblaAngle = calculateQiblaDirection(userCoords.latitude, userCoords.longitude);
                        try {
                            // Reverse geocoding to get city/country from coordinates
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${userCoords.latitude}&lon=${userCoords.longitude}`);
                            const data = await response.json();
                            const city = data.address.city || data.address.town || 'Unknown City';
                            const country = data.address.country || 'Unknown Country';
                            locationEl.textContent = `${city}, ${country}`;
                            const prayerData = await getPrayerTimes(city, country);
                            if (prayerData) updateCountdown(prayerData.timings);
                        } catch (error) {
                            console.error("Reverse geocoding failed, using IP fallback:", error);
                            await getLocationByIp(); // Fallback to IP if reverse geocoding fails
                        }
                        resolve();
                    },
                    async (error) => {
                        console.warn(`Geolocation error (${error.code}): ${error.message}. Falling back to IP.`);
                        // Provide user feedback for geolocation denial/error
                        locationEl.textContent = "Geolocation denied or failed. Using approximate location from network.";
                        showTemporaryMessage("Geolocation denied or failed. Using approximate location.", true);
                        await getLocationByIp(); // Fallback to IP if geolocation is denied or errors
                        resolve();
                    },
                    { timeout: 8000 } // Timeout for geolocation attempt
                );
            });
        }

        /**
         * Fetches prayer times for a given city and country from Aladhan API.
         * @param {string} city - The city name.
         * @param {string} country - The country name.
         * @returns {object|null} Prayer data if successful, otherwise null.
         */
        async function getPrayerTimes(city, country) {
            try {
                const date = new Date();
                const dateString = `${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}`; // Format: DD-MM-YYYY
                const response = await fetch(`https://api.aladhan.com/v1/timingsByCity/${dateString}?city=${encodeURIComponent(city)}&country=${encodeURIComponent(country)}&method=2`);
                const data = await response.json();
                if (data.code === 200) {
                    displayPrayerTimes(data.data);
                    // Populate calendar with current Hijri year from prayer data
                    populateEventCalendar(data.data.date.hijri.year);
                    return data.data;
                }
                console.error("Aladhan API error:", data.status, data.code, data.data);
                return null;
            } catch (error) { 
                console.error("Error fetching prayer times:", error); 
                return null; 
            }
        }

        /**
         * Subtracts minutes from a given time string.
         * Used for Sehri end time calculation (Fajr - 10 minutes).
         * @param {string} timeStr - Time in "HH:MM" format (24-hour).
         * @param {number} minutes - Number of minutes to subtract.
         * @returns {string} New time in "HH:MM" format (24-hour).
         */
        function subtractMinutes(timeStr, minutes) {
            const [h, m] = timeStr.split(':').map(Number);
            const time = new Date(); 
            time.setHours(h, m - minutes, 0, 0); // Set hours, minutes, seconds, milliseconds
            return `${padZero(time.getHours())}:${padZero(time.getMinutes())}`;
        }

        /**
         * Displays the fetched prayer times in the Salah view and updates Islamic date.
         * @param {object} data - Prayer time data from Aladhan API.
         */
        function displayPrayerTimes(data) {
            const { timings, date } = data;
            islamicDateEl.textContent = `${date.hijri.weekday.en}, ${date.hijri.day} ${date.hijri.month.en} ${date.hijri.year}`;
            
            // Update individual prayer time displays
            Object.keys(salahPrayerTimeElements).forEach(p => { 
                if (salahPrayerTimeElements[p] && timings[p]) 
                    salahPrayerTimeElements[p].textContent = formatTime(timings[p]); 
            });

            // Calculate and display Sehri and Iftar times
            document.querySelector('#salah-sehri span:last-child').textContent = formatTime(subtractMinutes(timings.Fajr, 10));
            document.querySelector('#salah-iftar span:last-child').textContent = formatTime(timings.Maghrib);
        }
        
        /**
         * Updates the countdown timer to the next prayer time.
         * @param {object} timings - Object containing prayer timings.
         */
        function updateCountdown(timings) {
            if (countdownInterval) clearInterval(countdownInterval); // Clear any existing interval

            let nextPrayerTriggered = false; // Flag to prevent multiple notifications for the same prayer
            countdownInterval = setInterval(() => {
                const now = new Date();
                const nextPrayer = findNextPrayer(now, timings);

                if (nextPrayer) {
                    // Reset trigger flag if the next prayer has changed
                    if (nextPrayer.name !== nextPrayerNameEl.textContent) {
                        nextPrayerTriggered = false;
                    }
                    nextPrayerNameEl.textContent = nextPrayer.name;

                    // Calculate time difference to the next prayer
                    const diff = new Date(`${now.toDateString()} ${nextPrayer.time}`).getTime() - now.getTime();

                    if (diff > 0) {
                        // Format and display remaining time
                        const h = Math.floor(diff / 3600000);
                        const m = Math.floor((diff % 3600000) / 60000);
                        const s = Math.floor((diff % 60000) / 1000);
                        countdownTimerEl.textContent = `${padZero(h)}:${padZero(m)}:${padZero(s)}`;

                        // Trigger notification when time is very close (e.g., within 1 second)
                        if (diff <= 1000 && !nextPrayerTriggered) { 
                            triggerPrayerNotification(nextPrayer.name); 
                            nextPrayerTriggered = true; 
                        }
                    } else {
                        // If prayer time has passed, re-fetch times to get next day's timings
                        // This handles cases where the app is open past Isha.
                        startLocationSearch(); 
                    }
                } else { 
                    // No more prayers for the current day
                    nextPrayerNameEl.textContent = 'Day Complete'; 
                    countdownTimerEl.textContent = '00:00:00'; 
                }
            }, 1000); // Update every second
        }

        /**
         * Finds the next upcoming prayer based on current time and prayer timings.
         * @param {Date} now - Current Date object.
         * @param {object} timings - Object of prayer timings.
         * @returns {object|null} Object with next prayer name and time, or null if day complete.
         */
        function findNextPrayer(now, timings) {
            // Define prayer order
            const prayerOrder = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            
            for (const prayerName of prayerOrder) {
                if (timings[prayerName]) {
                    const prayerTime = new Date(`${now.toDateString()} ${timings[prayerName]}`);
                    if (prayerTime > now) {
                        // Special handling for Sehri/Iftar if they are the next events
                        if (prayerName === 'Fajr') {
                            const sehriEndTime = new Date(`${now.toDateString()} ${subtractMinutes(timings.Fajr, 10)}`);
                            if (sehriEndTime > now) return { name: 'Sehri End', time: subtractMinutes(timings.Fajr, 10) };
                        } else if (prayerName === 'Maghrib') {
                            const iftarTime = new Date(`${now.toDateString()} ${timings.Maghrib}`);
                            if (iftarTime > now) return { name: 'Iftar', time: timings.Maghrib };
                        }
                        return { name: prayerName, time: timings[prayerName] };
                    }
                }
            }
            return null; // All prayers for the day have passed
        }

        /**
         * Shows the selected view and hides others. Manages audio playback state.
         * @param {string} viewName - The ID of the view to show (e.g., 'home', 'salah').
         */
        function showView(viewName) {
            manageAudioPlayback(null); // Pause all audio when switching views
            // Pause YouTube player if it's active
            if (youtubePlayer && typeof youtubePlayer.pauseVideo === 'function') { 
                youtubePlayer.pauseVideo(); 
            }
            
            // Hide all views
            Object.values(views).forEach(v => v.classList.add('hidden'));
            // Show the selected view
            if (views[viewName]) views[viewName].classList.remove('hidden');
            
            // Update navigation button active state
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            document.querySelector(`.nav-button[onclick="showView('${viewName}')"]`)?.classList.add('active');

            // Specific actions for certain views
            if (viewName === 'listenQuran' && !quranListLoaded) populateQuranList();
            if (viewName === 'qibla') startCompass(); else stopCompass();
        }

        /**
         * Hides the initial loading screen and reveals the main content.
         */
        function hideLoading() {
            loadingScreen.classList.add('opacity-0');
            setTimeout(() => { 
                loadingScreen.style.display = 'none'; 
                mainContent.classList.remove('opacity-0'); 
            }, 1500); // Allow transition to complete
        }

        /**
         * Starts the Qibla compass functionality by adding deviceorientation event listener.
         * Requests permission on iOS 13+ devices.
         */
        function startCompass() {
            // Request permission for device orientation on iOS 13+
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(p => { 
                    if (p === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation); 
                    } else {
                        qiblaDirectionEl.textContent = 'Permission denied for compass. Please enable in iOS settings.';
                    }
                }).catch(error => {
                    console.error("DeviceOrientationEvent permission error:", error);
                    qiblaDirectionEl.textContent = 'Error requesting compass permission.';
                });
            } else {
                // For browsers that don't require explicit permission or older iOS versions
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }

        /**
         * Stops the Qibla compass functionality by removing the event listener.
         */
        function stopCompass() { 
            window.removeEventListener('deviceorientation', handleOrientation); 
        }

        /**
         * Handles the device orientation event to update the Qibla line.
         * @param {DeviceOrientationEvent} event - The device orientation event.
         */
        function handleOrientation(event) {
            // webkitCompassHeading is for iOS, alpha for other browsers
            let alpha = event.webkitCompassHeading || event.alpha; 
            if (alpha !== null) {
                // Adjust for device orientation (portrait vs landscape) if needed,
                // but generally `webkitCompassHeading` provides true north.
                // Rotate the Qibla line based on the difference between Qibla angle and current device heading.
                qiblaLine.style.transform = `translateX(-50%) rotate(${qiblaAngle - alpha}deg)`;
            } else {
                qiblaDirectionEl.textContent = 'Compass not supported or calibrated on this device.';
            }
        }

        /**
         * Populates the list of Quran Surahs from an API.
         * Ensures the list is loaded only once.
         */
        async function populateQuranList() {
            if (quranListLoaded) return; // Prevent re-loading
            quranLoadingIndicator.classList.remove('hidden'); // Show loading indicator
            try {
                const response = await fetch('https://api.quran.com/api/v4/chapters');
                quranChapters = (await response.json()).chapters;
                quranSurahList.innerHTML = quranChapters.map((s, i) => `
                    <div id="surah-item-${s.id}" class="quran-surah cursor-pointer p-3 rounded-lg flex justify-between items-center bg-gray-800 hover:bg-gray-700 transition" onclick="playSurah(${s.id}, '${escapeHTML(s.name_simple)}', this, ${i})">
                        <div><p class="font-semibold">${s.id}. ${escapeHTML(s.name_simple)}</p><p class="text-sm text-gray-400">${escapeHTML(s.translated_name.name)}</p></div>
                        <div><i class="fas fa-play text-neon play-icon"></i><i class="fas fa-pause text-neon pause-icon hidden"></i></div>
                    </div>`).join('');
                quranListLoaded = true; // Mark as loaded
            } catch (e) { 
                console.error("Error loading Quran Surahs:", e);
                quranSurahList.innerHTML = `<p class="text-center text-red-400 col-span-full">Could not load Surahs. Please check your internet connection.</p>`; 
            } finally { 
                quranLoadingIndicator.style.display = 'none'; // Hide loading indicator
            }
        }
        
        /**
         * Resets the UI of a Quran Surah item (shows play icon, hides pause icon).
         * @param {HTMLElement} element - The Surah item's DOM element.
         */
        function resetQuranItemUI(element) {
            if (element) {
                const playIcon = element.querySelector('.play-icon');
                const pauseIcon = element.querySelector('.pause-icon');
                if (playIcon && pauseIcon) {
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                }
            }
        }
        
        /**
         * Plays a specific Surah recitation. Handles pausing/playing if same Surah is clicked.
         * @param {number} surahId - The ID of the Surah to play.
         * @param {string} surahName - The simple name of the Surah.
         * @param {HTMLElement} element - The DOM element of the clicked Surah item.
         * @param {number} index - The index of the Surah in the chapters array.
         */
        async function playSurah(surahId, surahName, element, index) {
            // If the same surah is clicked, toggle play/pause
            if (currentPlayingQuran.surahId === surahId) {
                if (quranAudioPlayer.paused) { 
                    await quranAudioPlayer.play(); 
                } else { 
                    quranAudioPlayer.pause(); 
                }
                return;
            }

            // Reset UI of previously playing Surah
            if (currentPlayingQuran.element) { 
                resetQuranItemUI(currentPlayingQuran.element); 
            }
            
            manageAudioPlayback('quran'); // Pause other audio sources
            currentSurahName.textContent = `Loading ${surahName}...`;
            quranPlayer.classList.remove('hidden'); // Show the audio player controls

            try {
                // Fetch audio URL for the selected Surah
                const response = await fetch(`https://api.quran.com/api/v4/chapter_recitations/7/${surahId}`); // Reciter 7 (Abdurrahman As-Sudais)
                if (!response.ok) throw new Error(`API request failed with status: ${response.status}`);
                const data = await response.json();
                
                if (!data.audio_file || !data.audio_file.audio_url) { 
                    throw new Error(`Audio not available for ${surahName}`); 
                }

                quranAudioPlayer.src = data.audio_file.audio_url;
                quranAudioPlayer.muted = false; // Ensure not muted
                quranAudioPlayer.volume = 1.0; // Set full volume
                
                await quranAudioPlayer.play(); // Attempt to play audio
                currentSurahName.textContent = surahName; // Update current Surah name
                currentPlayingQuran = { element, surahId, index }; // Store current playing Surah info
            } catch (error) {
                console.error("Error playing Surah:", error);
                currentSurahName.textContent = `Error: ${error.message}`; 
                resetQuranItemUI(element); // Reset UI on error
                currentPlayingQuran = { element: null, surahId: null, index: -1 }; // Clear current playing state
                showTemporaryMessage(`Failed to play ${surahName}. ${error.message}`, true);
            }
        }

        // Event listener for when Quran audio starts playing
        quranAudioPlayer.addEventListener('play', () => {
            if (currentPlayingQuran.element) {
                currentPlayingQuran.element.querySelector('.play-icon').classList.add('hidden');
                currentPlayingQuran.element.querySelector('.pause-icon').classList.remove('hidden');
            }
        });

        // Event listener for when Quran audio is paused
        quranAudioPlayer.addEventListener('pause', () => { 
            if (currentPlayingQuran.element) { 
                resetQuranItemUI(currentPlayingQuran.element); 
            } 
        });

        // Event listener for when Quran audio ends, plays next Surah automatically
        quranAudioPlayer.onended = () => {
            if (currentPlayingQuran.element) { 
                resetQuranItemUI(currentPlayingQuran.element); 
            }
            const nextIndex = currentPlayingQuran.index + 1;
            if (nextIndex < quranChapters.length) {
                const nextSurah = quranChapters[nextIndex];
                const nextElement = document.getElementById(`surah-item-${nextSurah.id}`);
                playSurah(nextSurah.id, nextSurah.name_simple, nextElement, nextIndex);
            } else {
                // All Surahs finished
                currentPlayingQuran = { element: null, surahId: null, index: -1 };
                currentSurahName.textContent = "Finished Recitation";
            }
        };

        /**
         * Sets up the radio player to manage audio playback when it starts playing.
         */
        function setupRadioPlayer() { 
            radioPlayer.addEventListener('play', () => manageAudioPlayback('radio')); 
        }
        
        /**
         * Increments the Tasbeeh counter and saves the count.
         */
        function incrementTasbeeh() { 
            tasbeehCounterDisplay.textContent = ++tasbeehCount; 
            saveTasbeebCount(); 
        }

        /**
         * Resets the Tasbeeh counter to zero and saves the count.
         */
        function resetTasbeeh() { 
            tasbeehCounterDisplay.textContent = tasbeehCount = 0; 
            saveTasbeebCount(); 
        }

        /**
         * Saves the current Tasbeeh count to local storage.
         */
        function saveTasbeebCount() { 
            localStorage.setItem('ramadanTasbeeh', tasbeehCount); 
        }

        /**
         * Loads the Tasbeeh count from local storage.
         */
        function loadTasbeehCount() { 
            tasbeehCount = parseInt(localStorage.getItem('ramadanTasbeeh') || '0', 10); 
            tasbeehCounterDisplay.textContent = tasbeehCount; 
        }

        /**
         * Initializes the YouTube Iframe API player for Naat collection.
         * This function is called automatically when the YouTube Iframe API script loads.
         */
        function onYouTubeIframeAPIReady() {
            youtubePlayer = new YT.Player('youtube-player', { 
                height: '480', 
                width: '854', 
                playerVars: { 
                    'playsinline': 1, // Crucial for iOS to play videos inline, not fullscreen automatically
                    'listType': 'playlist', 
                    'list': 'PL6b_3Yr67_wFpDJfaZLlMEUP6h5EroJi2', // Example playlist ID
                    'controls': 0, // Hide native YouTube controls
                    'rel': 0 // Do not show related videos
                }, 
                events: { 
                    'onStateChange': onPlayerStateChange 
                } 
            });
        }
        
        /**
         * Handles YouTube player state changes (playing, paused, ended).
         * Updates play/pause buttons accordingly.
         * @param {object} event - The YouTube player event object.
         */
        function onPlayerStateChange(event) {
            tvPlayButton.classList.toggle('hidden', event.data === YT.PlayerState.PLAYING);
            tvPauseButton.classList.toggle('hidden', event.data !== YT.PlayerState.PLAYING);
            if(event.data === YT.PlayerState.PLAYING) {
                manageAudioPlayback('naat'); // Pause other audio when YouTube video plays
            }
        }
        
        /** Plays the current YouTube video. */
        function playVideo() { 
            manageAudioPlayback('naat'); 
            if (youtubePlayer && typeof youtubePlayer.playVideo === 'function') {
                youtubePlayer.playVideo(); 
            }
        }

        /** Pauses the current YouTube video. */
        function pauseVideo() { 
            if (youtubePlayer && typeof youtubePlayer.pauseVideo === 'function') {
                youtubePlayer.pauseVideo(); 
            }
            intendedAudioSource = null; // Clear intended source when manually paused
        }

        /** Plays the next video in the YouTube playlist. */
        function nextVideo() { 
            if (youtubePlayer && typeof youtubePlayer.nextVideo === 'function') {
                youtubePlayer.nextVideo(); 
            }
        }

        /** Plays the previous video in the YouTube playlist. */
        function previousVideo() { 
            if (youtubePlayer && typeof youtubePlayer.previousVideo === 'function') {
                youtubePlayer.previousVideo(); 
            }
        }

        /** Loads Dua requests from local storage. */
        function loadDuas() {
            duaList = JSON.parse(localStorage.getItem(DUA_LIST_KEY) || '[]');
            displayDuas();
        }

        /** Displays the list of Dua requests in the UI. */
        function displayDuas() {
            if (!duaListContainer) return; // Ensure element exists
            if (duaList.length === 0) {
                duaListContainer.innerHTML = `<p class="text-center text-gray-400">No duas yet. Be the first to request one!</p>`;
                return;
            }
            // Map dua objects to HTML, escaping user-generated content
            duaListContainer.innerHTML = duaList
                .map(dua => `<div class="dua-item">
                                <p class="font-bold text-white">${escapeHTML(dua.name)} <span class="font-normal text-gray-300">(${escapeHTML(dua.relation)})</span></p>
                                <p class="text-gray-200 my-2">${escapeHTML(dua.text)}</p>
                                <small>Submitted: ${new Date(dua.timestamp).toLocaleString()}</small>
                            </div>`).join('');
        }
        
        /**
         * Escapes HTML entities in a string to prevent XSS attacks.
         * @param {string} str - The string to escape.
         * @returns {string} The escaped string.
         */
        function escapeHTML(str) {
            if (typeof str !== 'string') return str; // Return non-strings as is
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }
        
        // Event listener for Dua form submission
        duaForm.addEventListener('submit', function(e){
            e.preventDefault(); // Prevent default form submission
            const nameEl = document.getElementById('dua-name');
            const relationEl = document.getElementById('dua-relation');
            const textEl = document.getElementById('dua-text');
            const text = textEl.value.trim();

            if (text.length < 10) {
                showTemporaryMessage('Dua is too short. Please write a meaningful request (min 10 characters).', true);
                return;
            }
            
            // Simple content filtering for inappropriate words
            const forbiddenWords = ['badword', 'profanity', 'inappropriate', 'test', 'kill', 'fuck', 'shit', 'asshole']; // Add more as needed
            const filterPattern = new RegExp(forbiddenWords.join('|'), 'i'); // Case-insensitive regex
            if (filterPattern.test(text)) {
                showTemporaryMessage('Dua contains inappropriate content and cannot be submitted.', true);
                return;
            }

            // Create new dua object and add to list
            const newDua = { name: nameEl.value, relation: relationEl.value, text: text, timestamp: new Date().toISOString() };
            duaList.unshift(newDua); // Add to the beginning of the list
            localStorage.setItem(DUA_LIST_KEY, JSON.stringify(duaList)); // Save to local storage
            displayDuas(); // Re-render the list
            
            // Clear form fields
            nameEl.value = '';
            relationEl.value = '';
            textEl.value = '';
            showTemporaryMessage('Your dua has been submitted for the community!', false);
        });

        /** Updates the UI of the notification toggle button in settings. */
        function updateSettingsNotificationUI() {
            if (notificationsEnabled) {
                settingsNotificationToggle.textContent = 'Notifications are ON';
                settingsNotificationToggle.classList.add('bg-green-600', 'hover:bg-green-700');
                settingsNotificationToggle.classList.remove('bg-red-600', 'hover:bg-red-700');
            } else {
                settingsNotificationToggle.textContent = 'Notifications are OFF';
                settingsNotificationToggle.classList.add('bg-red-600', 'hover:bg-red-700');
                settingsNotificationToggle.classList.remove('bg-green-600', 'hover:bg-green-700');
            }
        }

        /** Saves the current notification status to local storage. */
        function saveNotificationStatus() { 
            localStorage.setItem(NOTIFICATION_STATUS_KEY, notificationsEnabled); 
        }

        /** Loads the notification status from local storage and updates UI. */
        function loadNotificationStatus() { 
            notificationsEnabled = localStorage.getItem(NOTIFICATION_STATUS_KEY) !== 'false'; 
            updateSettingsNotificationUI(); 
        }

        /** Toggles master notification control. Requests permission if needed. */
        function toggleMasterNotifications() {
            if (Notification.permission === 'denied') {
                showTemporaryMessage('Notifications are blocked by your browser. Please enable them in your browser settings.', true);
                return;
            }
            if (Notification.permission === 'default') {
                // Request permission if it hasn't been granted or denied yet
                Notification.requestPermission().then(p => { 
                    if (p === 'granted') { 
                        notificationsEnabled = true; // Automatically enable if granted
                        saveNotificationStatus(); 
                        updateSettingsNotificationUI(); 
                    } else {
                        notificationsEnabled = false; // Keep disabled if not granted
                        saveNotificationStatus();
                        updateSettingsNotificationUI();
                        showTemporaryMessage('Notification permission not granted.', true);
                    }
                }).catch(error => {
                    console.error("Notification permission request error:", error);
                    showTemporaryMessage('Error requesting notification permission.', true);
                });
            } else { 
                // Toggle if permission is already granted
                notificationsEnabled = !notificationsEnabled; 
                saveNotificationStatus(); 
                updateSettingsNotificationUI(); 
                showTemporaryMessage(`Notifications are now ${notificationsEnabled ? 'enabled' : 'disabled'}.`);
            }
        }

        /**
         * Logs a notification message to the inbox history.
         * @param {string} message - The notification message.
         * @param {string} type - Type of notification (e.g., 'salah', 'history').
         */
        function logNotification(message, type) {
            notificationLog.unshift({ message, type, timestamp: new Date().toISOString() }); // Add to beginning
            pruneNotificationLog(); // Keep log size manageable
            localStorage.setItem(NOTIFICATION_LOG_KEY, JSON.stringify(notificationLog));
            displayNotificationsInInbox(); // Update inbox UI
        }

        /** Loads notification history from local storage. */
        function loadNotificationLog() { 
            notificationLog = JSON.parse(localStorage.getItem(NOTIFICATION_LOG_KEY) || '[]'); 
            pruneNotificationLog(); // Clean up old entries on load
        }

        /** Removes notifications older than 2 days from the log. */
        function pruneNotificationLog() {
            const twoDaysAgo = new Date(); 
            twoDaysAgo.setDate(twoDaysAgo.getDate() - 2); // Set date to 2 days ago
            notificationLog = notificationLog.filter(i => new Date(i.timestamp) > twoDaysAgo);
            localStorage.setItem(NOTIFICATION_LOG_KEY, JSON.stringify(notificationLog));
        }
        
        /** Displays notification history in the inbox view. */
        function displayNotificationsInInbox() {
            if (notificationLog.length === 0) {
                inboxList.innerHTML = `<p class="text-center text-gray-400">No notifications in the last 48 hours.</p>`;
                return;
            }
            inboxList.innerHTML = notificationLog.map(i => 
                `<div class="inbox-item ${i.type==='history' ? 'history' : ''}">
                    <p>${escapeHTML(i.message)}</p>
                    <p class="timestamp">${new Date(i.timestamp).toLocaleDateString()} at ${new Date(i.timestamp).toLocaleTimeString()}</p>
                </div>`).join('');
        }

        /** Clears all notification history from inbox and local storage. */
        function clearInboxHistory() { 
            notificationLog = []; 
            localStorage.removeItem(NOTIFICATION_LOG_KEY); 
            displayNotificationsInInbox(); 
            showTemporaryMessage('Inbox history has been cleared.'); 
        }

        /**
         * Sends a browser notification and logs it.
         * @param {string} message - The notification message.
         * @param {string} type - The type of notification (e.g., 'salah').
         */
        function sendNotification(message, type) {
             if (!notificationsEnabled) return; // Do not send if disabled
             logNotification(message, type); // Log all attempted notifications
             if (Notification.permission === "granted") {
                 new Notification(message); // Create browser notification
             }
        }
        
        /**
         * Triggers a prayer time notification with Azan sound.
         * @param {string} prayerName - The name of the prayer (e.g., 'Fajr', 'Dhuhr').
         */
        function triggerPrayerNotification(prayerName) {
            if (!notificationsEnabled) return;
            sendNotification(`It's time for ${prayerName} prayer!`, 'salah');
            const audio = prayerName === 'Fajr' ? azanFajrAudio : azanOtherAudio;
            if (audio) {
                // Attempt to play audio, catching potential autoplay errors on iOS/browsers
                audio.play().catch(e => {
                    console.warn("Azan audio playback blocked:", e);
                    showTemporaryMessage('Azan blocked by browser. Please interact with the page to enable audio.', true);
                });
            }
        }

        /** Saves general app settings to local storage. */
        function saveSettings() { 
            localStorage.setItem('ramadanAppSettings', JSON.stringify(settings)); 
            showTemporaryMessage('Settings Saved!'); 
        }

        /** Loads general app settings from local storage. */
        function loadSettings() { 
            const s = localStorage.getItem('ramadanAppSettings'); 
            if (s) settings = JSON.parse(s); 
        }
        
        /**
         * Displays a temporary message at the bottom of the screen.
         * @param {string} message - The message to display.
         * @param {boolean} isError - True if it's an error message, changes background color.
         */
        function showTemporaryMessage(message, isError = false) {
            settingsSavedMessage.textContent = message;
            settingsSavedMessage.style.backgroundColor = isError ? '#ef4444' : '#10B981'; // Red for error, green for success
            settingsSavedMessage.classList.remove('opacity-0'); // Make visible
            setTimeout(() => { 
                settingsSavedMessage.classList.add('opacity-0'); // Fade out after 4 seconds
            }, 4000);
        }

        /**
         * Formats a 24-hour time string to 12-hour AM/PM format.
         * @param {string} time24 - Time in "HH:MM" (24-hour) format.
         * @returns {string} Formatted time (e.g., "01:00 PM").
         */
        function formatTime(time24) {
            const [h, m] = time24.split(':');
            const hour = parseInt(h, 10);
            return `${padZero(hour % 12 || 12)}:${m} ${hour >= 12 ? 'PM' : 'AM'}`;
        }

        /**
         * Pads a number with a leading zero if it's less than 10.
         * @param {number} num - The number to pad.
         * @returns {string} The padded number as a string.
         */
        function padZero(num) { 
            return num < 10 ? '0' + num : String(num); 
        }

        // Initialize the app when the window has fully loaded
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
