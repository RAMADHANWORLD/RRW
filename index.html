<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Q3PR0133TR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Q3PR0133TR');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramadhan World App</title>
    <meta name="google-adsense-account" content="ca-pub-8794459819365243">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }
        .font-amiri {
            font-family: 'Amiri', serif;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* Enhanced Dynamic Background */
        .countdown-background {
            position: relative;
            border-radius: 1rem;
            overflow: hidden;
            min-height: 250px;
        }

        .sky-gradient {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            transition: background 2s ease-in-out;
            border-radius: 1rem;
        }

        .day-sky { background: linear-gradient(to bottom, #87ceeb 0%, #98d8e8 50%, #b0e0e6 100%); }
        .night-sky { background: linear-gradient(to bottom, #000428 0%, #004e92 100%); }
        
        .celestial-container {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
        }

        .sun, .moon {
            position: absolute;
            transition: all 2s ease-in-out;
            z-index: 5;
        }

        .sun {
            width: 60px; height: 60px;
            background: radial-gradient(circle, #ffd700 0%, #ff8c00 100%);
            border-radius: 50%;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
        }

        .moon {
            width: 50px; height: 50px;
            background: radial-gradient(circle, #f5f5dc 0%, #ddd 100%);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(245, 245, 220, 0.6);
        }
        
        .stars {
            position: absolute;
            width: 100%; height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #fff, transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent);
            background-size: 200px 100px;
            opacity: 0;
            transition: opacity 2s ease-in-out;
            z-index: 1;
        }
        .stars.visible { opacity: 1; }

        /* Neon Green Theme Updates */
        #countdown-heading {
            font-weight: 700; color: #ffffff;
            text-shadow: 0 0 4px #39FF14, 0 0 8px #39FF14;
            position: relative; z-index: 10;
        }
        #countdown-timer {
            font-weight: 700; font-size: 4.5rem; color: #ffffff;
            text-shadow: 0 0 5px #39FF14, 0 0 10px #39FF14, 0 0 20px #39FF14, 0 0 30px #39FF14;
            letter-spacing: 0.05em; position: relative; z-index: 10;
        }
        #next-prayer-name { color: #39FF14; font-weight: 700; }
        
        .prayer-time {
            transition: all 0.3s ease;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .prayer-time.active {
            background-color: rgba(57, 255, 20, 0.2);
            border-left-width: 4px;
            border-color: #39FF14;
            transform: translateX(5px);
        }
        
        .nav-button.active {
            background-color: #39FF14; color: #000; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .nav-button:hover { background-color: #39FF14; color: #000; }
        
        #qibla-line {
            background-color: #39FF14;
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.7);
        }

        .section-title {
            font-family: 'Cairo', sans-serif; font-weight: 700; font-size: 1.875rem;
            text-align: center; margin-bottom: 1.5rem; color: #ffffff;
            text-shadow: 0 0 5px #39FF14, 0 0 10px #39FF14;
        }

        /* Settings Enhancements */
        .settings-section {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(57, 255, 20, 0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: rgba(255, 255, 255, 0.03);
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .settings-select, .settings-input {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }
        .save-button {
            background: linear-gradient(135deg, #39FF14 0%, #32d12a 100%);
            color: #000;
            font-weight: bold;
            padding: 0.75rem 2rem;
            border-radius: 0.75rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(57, 255, 20, 0.3);
        }

        /* Enhanced Islamic Content */
        .islamic-content-card {
            background: linear-gradient(135deg, rgba(57, 255, 20, 0.1) 0%, rgba(57, 255, 20, 0.05) 100%);
            border: 1px solid rgba(57, 255, 20, 0.3); border-radius: 1rem;
            padding: 2rem; margin-bottom: 1.5rem; position: relative; overflow: hidden;
        }
        .islamic-content-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, #39FF14 0%, #32d12a 100%);
        }

        /* Original Quran Player Styles */
        #quran-player-container {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(57, 255, 20, 0.3);
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        #current-surah-name { color: #ffffff; text-shadow: 0 0 3px #39FF14; }
        .quran-surah {
            cursor: pointer; padding: 0.75rem; border-radius: 0.5rem;
            transition: background-color 0.2s ease;
        }
        .quran-surah:hover { background-color: rgba(57, 255, 20, 0.2); }
        .quran-surah.playing {
            background-color: rgba(57, 255, 20, 0.3); border-left: 4px solid #39FF14;
        }
        .quran-surah.playing .surah-name { color: #39FF14; font-weight: bold; }
        .play-pause-icon { color: #39FF14; font-size: 1.25rem; }

        /* Original Radio Player Highlight */
        #home-radio-audio-player {
            border-radius: 50px;
            box-shadow: 0 0 8px #39FF14, 0 0 12px #39FF14;
            transition: box-shadow 0.3s ease;
        }

        /* Original General Styles */
        .video-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 0.75rem; max-width: 960px; margin: auto; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #compass { position: relative; width: 256px; height: 256px; background-color: #1f2937; border-radius: 9999px; border: 4px solid #374151; display: flex; align-items: center; justify-content: center; margin: 2rem auto; }
        
        .hadith-archive-item {
            background-color: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #39FF14;
            padding: 1rem;
            border-radius: 0 0.5rem 0.5rem 0;
        }

        @keyframes glow {
            0%, 100% { text-shadow: 0 0 5px #39FF14, 0 0 10px #39FF14; }
            50% { text-shadow: 0 0 10px #39FF14, 0 0 20px #39FF14, 0 0 30px #39FF14; }
        }
        .glow-animation { animation: glow 2s ease-in-out infinite; }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="loading-screen" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col justify-center items-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4" style="border-color: #39FF14;"></div>
        <p class="mt-4 text-lg">Finding your location and fetching data...</p>
    </div>

    <div id="main-content" class="min-h-screen container mx-auto p-4 sm:p-6 lg:p-8 opacity-0 transition-opacity duration-1000">
        <!-- Header Section -->
        <header class="text-center mb-6">
            <img id="app-logo" src="https://i.ibb.co/Zp0bgjsS/ART-WORKS-1.png" alt="Ramadhan World Logo" class="w-[200px] h-[200px] mx-auto mb-4 rounded-full shadow-lg object-contain">
            <h1 class="text-4xl sm:text-5xl font-extrabold glow-animation" style="color: #39FF14;">Ramadhan World</h1>
            <p id="islamic-date" class="text-lg text-gray-300 mt-2">Loading Islamic Date...</p>
            <p id="location" class="text-md text-gray-400 mt-1">Fetching location...</p>
        </header>

        <!-- Navigation -->
        <nav class="flex justify-center gap-2 mb-6 flex-wrap items-center">
            <button onclick="showView('home')" class="nav-button active px-4 py-2 rounded-lg bg-gray-700 transition">Home</button>
            <button onclick="showView('salah')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 transition">Salah</button>
            <button onclick="showView('listenQuran')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 transition">Quran</button>
            <button onclick="showView('hadith')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 transition">Hadith</button>
            <button onclick="showView('tasbeeh')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 transition">Tasbeeh</button>
            <button onclick="showView('naat')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 transition">Naat</button>
            <button onclick="showView('qibla')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 transition">Qibla</button>
            <button onclick="showView('settings')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 transition">Settings</button>
        </nav>

        <!-- Main Views -->
        <main>
            <!-- Home View -->
            <div id="home-view">
                <section id="countdown-section" class="mb-8">
                     <div class="countdown-background p-6 max-w-2xl mx-auto text-center">
                        <div id="sky-gradient" class="sky-gradient"></div>
                        <div class="celestial-container">
                            <div id="sun" class="sun" style="display: none;"></div>
                            <div id="moon" class="moon" style="display: none;"></div>
                            <div id="stars" class="stars"></div>
                        </div>
                        <h2 id="countdown-heading" class="text-2xl mb-2">Time until <span id="next-prayer-name">...</span></h2>
                        <div id="countdown-timer" class="tracking-wider">00:00:00</div>
                    </div>
                </section>
                
                <section id="home-radio-section" class="mb-8">
                    <div class="card rounded-2xl p-6 max-w-2xl mx-auto text-center">
                        <h3 class="text-xl font-bold mb-4" style="color: #39FF14; text-shadow: 0 0 5px rgba(57, 255, 20, 0.7);">PRESS TO PLAY LIVE RADIO</h3>
                        <audio id="home-radio-audio-player" controls class="w-full"></audio>
                    </div>
                </section>

                <section id="daily-message-section" class="mb-8">
                    <div class="islamic-content-card max-w-3xl mx-auto text-center">
                         <p id="daily-islamic-message" class="text-2xl font-bold mb-2" style="color: #39FF14; text-shadow: 0 0 5px rgba(57, 255, 20, 0.7);">"Indeed, in the remembrance of Allah do hearts find rest."</p>
                         <p id="daily-islamic-message-ref" class="text-lg text-green-200">— Surah Ar-Ra'd (13:28)</p>
                    </div>
                </section>

                <section id="hadith-section-home" class="mb-8">
                    <div class="islamic-content-card max-w-3xl mx-auto text-center">
                        <div id="hadith-content-home">
                           <!-- Hadith will be loaded here -->
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- Hadith Archive View -->
            <div id="hadith-view" class="hidden">
                 <div class="card rounded-2xl p-6 max-w-4xl mx-auto">
                    <h2 class="section-title">📜 Hadith Archive</h2>
                    <div id="hadith-log-list" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                        <!-- Hadith log will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Qibla View -->
            <div id="qibla-view" class="hidden text-center">
                 <div class="card rounded-2xl p-6 max-w-sm mx-auto">
                    <h2 class="text-2xl font-semibold mb-4">Qibla Compass</h2>
                    <div id="compass">
                        <div id="qibla-line" style="transform-origin: bottom center; transition: transform 0.2s linear; position: absolute; width: 3px; height: 128px; top: 0px; left: 50%;"></div>
                    </div>
                    <p id="qibla-direction" class="mt-4 text-lg text-gray-300">For accurate results, hold your device flat, away from any metals.</p>
                </div>
            </div>

            <!-- Listen Quran View -->
            <div id="listenQuran-view" class="hidden">
                <div class="card rounded-2xl p-6 max-w-4xl mx-auto">
                    <h2 class="section-title">Holy Quran Recitation</h2>
                    <!-- Elegant Player -->
                    <div id="quran-player-container">
                        <h3 id="current-surah-name" class="text-xl font-bold mb-2 text-center">Select a Surah to Play</h3>
                        <audio id="quran-audio-player" controls class="w-full rounded-lg"></audio>
                    </div>
                    <!-- Surah List -->
                    <div id="quran-surah-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto pr-2">
                        <!-- Surahs will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Salah View -->
            <div id="salah-view" class="hidden">
                 <div class="card rounded-2xl p-6 max-w-4xl mx-auto">
                    <h2 class="section-title">🕌 Prayer Times</h2>
                    <div class="mb-4 text-center">
                        <p class="text-sm text-gray-300 mb-2">Calculation Method: <span id="current-madhab" class="text-green-400 font-semibold"></span></p>
                    </div>
                    <div id="prayer-times-container" class="space-y-3">
                        <!-- Prayer times will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Tasbeeh View -->
            <div id="tasbeeh-view" class="hidden">
                 <div class="card rounded-2xl p-6 max-w-sm mx-auto text-center">
                    <h2 class="text-2xl font-semibold mb-4">Tasbeeh Counter</h2>
                    <div id="tasbeeh-counter-display" class="font-mono text-7xl font-bold text-green-400 mb-4">0</div>
                    <button onclick="incrementTasbeeh()" class="w-48 h-48 rounded-full bg-green-500 text-black text-5xl flex items-center justify-center mx-auto shadow-lg transform transition hover:scale-105 active:scale-95"><i class="fas fa-plus"></i></button>
                    <button onclick="resetTasbeeh()" class="mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition">Reset</button>
                </div>
            </div>
            
            <!-- Naat View -->
            <div id="naat-view" class="hidden">
                <div class="card rounded-2xl p-6 mx-auto text-center">
                    <h2 class="text-2xl font-semibold mb-4">Naat Collection</h2>
                    <div class="video-container mb-4">
                        <div id="youtube-player"></div>
                    </div>
                    <div class="flex justify-center gap-4 flex-wrap">
                        <button onclick="previousVideo()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full text-lg"><i class="fas fa-backward"></i></button>
                        <button id="tv-play-button" onclick="playVideo()" class="text-black font-bold py-2 px-4 rounded-full text-lg" style="background-color: #39FF14;"><i class="fas fa-play"></i></button>
                        <button id="tv-pause-button" onclick="pauseVideo()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full text-lg hidden"><i class="fas fa-pause"></i></button>
                        <button onclick="nextVideo()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full text-lg"><i class="fas fa-forward"></i></button>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="hidden">
                <div class="card rounded-2xl p-6 max-w-4xl mx-auto">
                    <h2 class="section-title">⚙️ Settings</h2>
                    
                    <div class="settings-section">
                        <h3 class="text-xl font-bold mb-4 text-green-400">Islamic Jurisprudence (Madhab)</h3>
                        <div class="settings-option">
                            <label class="text-lg">Asr Time Calculation:</label>
                            <select id="madhab-select" class="settings-select">
                                <option value="0">Standard (Shafi, Maliki, Hanbali)</option>
                                <option value="1">Hanafi</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3 class="text-xl font-bold mb-4 text-green-400">Calculation Convention</h3>
                        <div class="settings-option">
                            <label class="text-lg">Calculation Method:</label>
                             <select id="calculation-method" class="settings-select">
                                <option value="2">University of Islamic Sciences, Karachi</option>
                                <option value="4">Muslim World League</option>
                                <option value="3">Islamic Society of North America</option>
                                <option value="5">Umm Al-Qura University, Makkah</option>
                                <option value="1">Jafari (Shia Ithna-Ansari)</option>
                                <option value="8">Kuwait</option>
                                <option value="10">Qatar</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3 class="text-xl font-bold mb-4 text-green-400">Prayer Time Adjustments (in minutes)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="settings-option">
                                <label class="text-lg">Fajr:</label>
                                <input type="number" id="fajr-adjustment" class="settings-input w-20" value="0" min="-60" max="60">
                            </div>
                            <div class="settings-option">
                                <label class="text-lg">Dhuhr:</label>
                                <input type="number" id="dhuhr-adjustment" class="settings-input w-20" value="0" min="-60" max="60">
                            </div>
                            <div class="settings-option">
                                <label class="text-lg">Asr:</label>
                                <input type="number" id="asr-adjustment" class="settings-input w-20" value="0" min="-60" max="60">
                            </div>
                            <div class="settings-option">
                                <label class="text-lg">Maghrib:</label>
                                <input type="number" id="maghrib-adjustment" class="settings-input w-20" value="0" min="-60" max="60">
                            </div>
                            <div class="settings-option">
                                <label class="text-lg">Isha:</label>
                                <input type="number" id="isha-adjustment" class="settings-input w-20" value="0" min="-60" max="60">
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-6">
                        <button onclick="saveSettings()" class="save-button">
                            <i class="fas fa-save mr-2"></i>Save Settings
                        </button>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Ad Units & Footer -->
        <div class="text-center mt-8">
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8794459819365243"
                 crossorigin="anonymous"></script>
            <ins class="adsbygoogle" style="display:inline-block;width:350px;height:50px" data-ad-client="ca-pub-8794459819365243" data-ad-slot="6996642780"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>
        <footer class="text-center p-4 text-sm text-gray-600 space-x-4">
          <a href="about.html" class="text-blue-600 underline">About</a>
          <a href="privacy.html" class="text-blue-600 underline">Privacy Policy</a>
          <a href="contact.html" class="text-blue-600 underline">Contact</a>
        </footer>
        <div class="text-center mt-4">
            <script type="text/javascript">
                atOptions = {'key' : '8f697970fa99026192276a59a8cce75b', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
            </script>
            <script type="text/javascript" src="//www.highperformanceformat.com/8f697970fa99026192276a59a8cce75b/invoke.js"></script>
        </div>
    </div>

    <div id="settings-saved-message" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300"></div>
    
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // --- DOM Elements & State ---
        const loadingScreen = document.getElementById('loading-screen');
        const mainContent = document.getElementById('main-content');
        const islamicDateEl = document.getElementById('islamic-date');
        const locationEl = document.getElementById('location');
        const nextPrayerNameEl = document.getElementById('next-prayer-name');
        const countdownTimerEl = document.getElementById('countdown-timer');
        const views = { home: document.getElementById('home-view'), qibla: document.getElementById('qibla-view'), listenQuran: document.getElementById('listenQuran-view'), salah: document.getElementById('salah-view'), hadith: document.getElementById('hadith-view'), tasbeeh: document.getElementById('tasbeeh-view'), naat: document.getElementById('naat-view'), settings: document.getElementById('settings-view') };
        const qiblaLine = document.getElementById('qibla-line');
        const quranSurahList = document.getElementById('quran-surah-list');
        const quranAudioPlayer = document.getElementById('quran-audio-player');
        const currentSurahName = document.getElementById('current-surah-name');
        const homeRadioAudioPlayer = document.getElementById('home-radio-audio-player');
        
        let tasbeehCount = 0;
        let countdownInterval;
        let qiblaAngle = 0;
        let youtubePlayer;
        let quranChapters = [];
        let currentSurahIndex = -1;
        let currentPlayingSurahElement = null;
        let userCoords = null;

        // --- Local Storage Keys ---
        const SETTINGS_KEY = 'ramadhanWorldSettings_v2';
        const HADITH_LOG_KEY = 'ramadanAppHadithLog';
        
        const radioStations = [{ name: "Ramadhan World", url: "https://ramadhan786.radioca.st/;" }];

        const curatedHadiths = [
            { text: "The Prophet (ﷺ) said, 'The best among you are those who have the best manners and character.'", ref: "Sahih al-Bukhari 3559" },
            { text: "The Prophet (ﷺ) said, 'A Muslim is a brother of another Muslim... Whoever fulfilled the needs of his brother, Allah will fulfill his needs.'", ref: "Sahih al-Bukhari 2442" },
            { text: "The Prophet (ﷺ) said, 'None of you will have faith till he wishes for his (Muslim) brother what he likes for himself.'", ref: "Sahih al-Bukhari 13" },
            { text: "The Prophet (ﷺ) said, 'He who is not merciful to others, will not be treated mercifully.'", ref: "Sahih al-Bukhari 5997" },
            { text: "The Prophet (ﷺ) said, 'Exchange gifts, you will love one another.'", ref: "Al-Adab Al-Mufrad 594" }
        ];

        const curatedQuranMessages = [
            { text: "Indeed, in the remembrance of Allah do hearts find rest.", ref: "Surah Ar-Ra'd (13:28)" },
            { text: "And He is with you wherever you are.", ref: "Surah Al-Hadid (57:4)" },
            { text: "And seek help through patience and prayer.", ref: "Surah Al-Baqarah (2:45)" }
        ];

        // --- Core App Logic ---
        document.addEventListener('DOMContentLoaded', initializeApp);

        async function initializeApp() {
            loadSettingsToUI();
            loadTasbeehCount();
            setupRadioPlayer();
            updateContentOnInterval();
            setInterval(updateContentOnInterval, 3600 * 1000); // Update every hour

            await getUserLocation();
            await populateQuranList();
            quranAudioPlayer.addEventListener('ended', playNextSurah);
        }

        function showView(viewName) {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewName]) views[viewName].classList.remove('hidden');
            
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.nav-button[onclick="showView('${viewName}')"]`).classList.add('active');
            
            if (viewName === 'qibla') startCompass();
            else stopCompass();
        }

        function hideLoading() {
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                mainContent.classList.remove('opacity-0');
            }, 500);
        }

        // --- Location & Prayer Times ---
        function getUserLocation() {
             return new Promise((resolve) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userCoords = { latitude: position.coords.latitude, longitude: position.coords.longitude };
                            qiblaAngle = calculateQiblaDirection(userCoords.latitude, userCoords.longitude);
                            getPrayerTimes(userCoords.latitude, userCoords.longitude);
                            resolve();
                        },
                        () => { // On Error
                            locationEl.textContent = "Location denied. Using default times for Makkah.";
                            getPrayerTimes(21.4225, 39.8262); // Default to Makkah
                            resolve();
                        }
                    );
                } else {
                     locationEl.textContent = "Geolocation not supported. Using default times for Makkah.";
                     getPrayerTimes(21.4225, 39.8262);
                     resolve();
                }
            });
        }

        async function getPrayerTimes(latitude, longitude) {
            try {
                const settings = getSettings();
                const date = new Date();
                const dateString = `${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}`;
                const adjustments = `${settings.fajr},0,${settings.dhuhr},${settings.asr},0,${settings.maghrib},0,${settings.isha}`;

                const apiUrl = `https://api.aladhan.com/v1/timings/${dateString}?latitude=${latitude}&longitude=${longitude}&method=${settings.method}&school=${settings.madhab}&tune=${adjustments}`;
                
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.code === 200) {
                    displayPrayerTimes(data.data);
                    updateCountdown(data.data.timings);
                    updateDynamicBackground(data.data.timings);
                    islamicDateEl.textContent = data.data.date.readable;
                    updateLocationName(latitude, longitude, data.data.meta.timezone);
                }
            } catch (error) {
                console.error("Error fetching prayer times:", error);
            } finally {
                hideLoading();
            }
        }
        
        async function updateLocationName(lat, lon, timezone) {
            try {
                 const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                 const data = await response.json();
                 const city = data.address.city || data.address.town || timezone.split('/')[1].replace('_', ' ');
                 const country = data.address.country || '';
                 locationEl.textContent = `${city}, ${country}`;
            } catch {
                 locationEl.textContent = timezone.split('/')[1].replace('_', ' ');
            }
        }

        function displayPrayerTimes(data) {
            const container = document.getElementById('prayer-times-container');
            const prayerOrder = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            container.innerHTML = ''; 

            const methodText = document.querySelector(`#calculation-method option[value='${data.meta.method.id}']`)?.textContent || 'Custom';
            document.getElementById('current-madhab').textContent = methodText;

            prayerOrder.forEach(prayer => {
                const time = data.timings[prayer];
                const prayerDiv = document.createElement('div');
                prayerDiv.className = `prayer-time p-4 bg-gray-800 rounded-lg flex justify-between items-center transition-all duration-300`;
                prayerDiv.innerHTML = `
                    <span class="font-semibold capitalize">${prayer}</span>
                    <span class="text-xl font-mono">${formatTime(time)}</span>
                `;
                container.appendChild(prayerDiv);
            });
        }
        
        function updateCountdown(timings) {
            if (countdownInterval) clearInterval(countdownInterval);
            
            countdownInterval = setInterval(() => {
                const now = new Date();
                const prayerOrder = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
                let nextPrayer = null;

                for (const prayerName of prayerOrder) {
                    const prayerTime = new Date(`${now.toDateString()} ${timings[prayerName]}`);
                    if (prayerTime > now) {
                        nextPrayer = { name: prayerName, time: timings[prayerName] };
                        break;
                    }
                }

                let prayerTimeObj;
                if (nextPrayer === null) { // After Isha, countdown to next day's Fajr
                    nextPrayer = { name: 'Fajr', time: timings.Fajr };
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    prayerTimeObj = new Date(`${tomorrow.toDateString()} ${nextPrayer.time}`);
                } else {
                    prayerTimeObj = new Date(`${now.toDateString()} ${nextPrayer.time}`);
                }

                nextPrayerNameEl.textContent = nextPrayer.name;
                const diff = prayerTimeObj.getTime() - now.getTime();
                
                if (diff > 0) {
                    const hours = Math.floor(diff / 3600000);
                    const minutes = Math.floor((diff % 3600000) / 60000);
                    const seconds = Math.floor((diff % 60000) / 1000);
                    countdownTimerEl.textContent = `${padZero(hours)}:${padZero(minutes)}:${padZero(seconds)}`;
                } else {
                    getUserLocation(); // Refresh times
                }

                 // Highlight current prayer
                document.querySelectorAll('.prayer-time').forEach(el => el.classList.remove('active'));
                let currentPrayerName = prayerOrder.slice().reverse().find(p => new Date(`${now.toDateString()} ${timings[p]}`) < now) || 'Isha';
                const activeElement = Array.from(document.querySelectorAll('.prayer-time .font-semibold')).find(el => el.textContent.toLowerCase() === currentPrayerName.toLowerCase());
                if (activeElement) activeElement.parentElement.classList.add('active');

            }, 1000);
        }
        
        function updateDynamicBackground(timings) {
            const now = new Date();
            const sunriseTime = new Date(`${now.toDateString()} ${timings.Sunrise}`);
            const maghribTime = new Date(`${now.toDateString()} ${timings.Maghrib}`);
            const skyGradient = document.getElementById('sky-gradient');
            const sun = document.getElementById('sun');
            const moon = document.getElementById('moon');
            const stars = document.getElementById('stars');
            const container = document.querySelector('.celestial-container');

            const isNight = now < sunriseTime || now > maghribTime;

            skyGradient.className = `sky-gradient ${isNight ? 'night-sky' : 'day-sky'}`;
            sun.style.display = isNight ? 'none' : 'block';
            moon.style.display = isNight ? 'block' : 'none';
            stars.classList.toggle('visible', isNight);
            
            const totalDaylight = maghribTime - sunriseTime;
            const progress = isNight ? 0 : (now - sunriseTime) / totalDaylight;
            
            if (container && sun) {
                const x = progress * (container.offsetWidth - sun.offsetWidth);
                const y = (container.offsetHeight / 2) - Math.sin(progress * Math.PI) * (container.offsetHeight * 0.4);
                sun.style.left = `${x}px`;
                sun.style.top = `${y}px`;
            }
        }

        // --- UI & Content Updates ---
        function updateContentOnInterval() {
            const hour = new Date().getHours();
            const quranMessage = curatedQuranMessages[hour % curatedQuranMessages.length];
            document.getElementById('daily-islamic-message').textContent = `"${quranMessage.text}"`;
            document.getElementById('daily-islamic-message-ref').textContent = `— ${quranMessage.ref}`;

            const hadith = curatedHadiths[hour % curatedHadiths.length];
            document.getElementById('hadith-content-home').innerHTML = `
                <h3 class="text-xl font-bold mb-4 text-green-400">Hadith of the Hour</h3>
                <p class="text-lg mb-4 font-amiri">"${hadith.text}"</p>
                <p class="text-sm text-gray-400">— ${hadith.ref}</p>
            `;
            addHadithToLog(hadith);
            populateHadithLogPage();
        }

        function addHadithToLog(hadith) {
            let log = JSON.parse(localStorage.getItem(HADITH_LOG_KEY) || '[]');
            if (!log.some(item => item.ref === hadith.ref)) {
                log.unshift(hadith);
                localStorage.setItem(HADITH_LOG_KEY, JSON.stringify(log.slice(0, 50)));
            }
        }

        function populateHadithLogPage() {
            const list = document.getElementById('hadith-log-list');
            const log = JSON.parse(localStorage.getItem(HADITH_LOG_KEY) || '[]');
            list.innerHTML = log.length ? log.map(h => `
                <div class="hadith-archive-item text-center p-4">
                    <p class="font-amiri text-xl">"${h.text}"</p>
                    <p class="text-base text-green-300 mt-2">${h.ref}</p>
                </div>`).join('') : `<p class="text-center text-gray-400">No hadith history.</p>`;
        }

        // --- Qibla Compass ---
        function calculateQiblaDirection(lat, lon) {
            const P = { lat: 21.4225 * Math.PI / 180, lon: 39.8262 * Math.PI / 180 };
            const A = { lat: lat * Math.PI / 180, lon: lon * Math.PI / 180 };
            return (Math.atan2(Math.sin(P.lon - A.lon), (Math.cos(A.lat) * Math.tan(P.lat)) - (Math.sin(A.lat) * Math.cos(P.lon - A.lon)))) * 180 / Math.PI;
        }
        
        function startCompass() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(p => { if (p === 'granted') window.addEventListener('deviceorientation', handleOrientation) });
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }
        function stopCompass() { window.removeEventListener('deviceorientation', handleOrientation); }

        function handleOrientation(event) {
            let alpha = event.webkitCompassHeading || event.alpha;
            if (alpha !== null && qiblaLine) {
                qiblaLine.style.transform = `translateX(-50%) rotate(${qiblaAngle - alpha}deg)`;
            }
        }
        
        // --- Settings Logic ---
        function getSettings() {
            const defaults = { method: '2', madhab: '0', fajr: 0, dhuhr: 0, asr: 0, maghrib: 0, isha: 0 };
            const saved = JSON.parse(localStorage.getItem(SETTINGS_KEY));
            return { ...defaults, ...saved };
        }

        function loadSettingsToUI() {
            const settings = getSettings();
            document.getElementById('calculation-method').value = settings.method;
            document.getElementById('madhab-select').value = settings.madhab;
            document.getElementById('fajr-adjustment').value = settings.fajr;
            document.getElementById('dhuhr-adjustment').value = settings.dhuhr;
            document.getElementById('asr-adjustment').value = settings.asr;
            document.getElementById('maghrib-adjustment').value = settings.maghrib;
            document.getElementById('isha-adjustment').value = settings.isha;
        }

        function saveSettings() {
            const settings = {
                method: document.getElementById('calculation-method').value,
                madhab: document.getElementById('madhab-select').value,
                fajr: document.getElementById('fajr-adjustment').value || 0,
                dhuhr: document.getElementById('dhuhr-adjustment').value || 0,
                asr: document.getElementById('asr-adjustment').value || 0,
                maghrib: document.getElementById('maghrib-adjustment').value || 0,
                isha: document.getElementById('isha-adjustment').value || 0
            };
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            showTemporaryMessage('Settings Saved. Refreshing times...');
            loadingScreen.style.display = 'flex';
            loadingScreen.style.opacity = '1';
            mainContent.classList.add('opacity-0');
            getUserLocation();
        }

        // --- Original Player/Counter Logic ---
        async function populateQuranList() {
            try {
                const response = await fetch('https://api.quran.com/api/v4/chapters');
                quranChapters = (await response.json()).chapters;
                quranSurahList.innerHTML = quranChapters.map((surah, index) => `
                    <div id="surah-item-${surah.id}" class="quran-surah flex justify-between items-center" onclick="toggleSurahPlay(${surah.id}, ${index})">
                        <div>
                            <p class="surah-name font-semibold">${surah.id}. ${surah.name_simple}</p>
                            <p class="text-sm text-gray-400">${surah.translated_name.name}</p>
                        </div>
                        <i id="icon-${surah.id}" class="fas fa-play play-pause-icon"></i>
                    </div>`).join('');
            } catch (error) { console.error("Error fetching Surahs:", error); }
        }
        async function toggleSurahPlay(surahId, index) {
            if (currentPlayingSurahElement && currentPlayingSurahElement !== document.getElementById(`surah-item-${surahId}`)) quranAudioPlayer.pause();
            if (document.getElementById(`surah-item-${surahId}`).classList.contains('playing') && !quranAudioPlayer.paused) {
                quranAudioPlayer.pause();
            } else {
                if (currentSurahIndex === index) {
                    quranAudioPlayer.play();
                } else {
                    try {
                        const response = await fetch(`https://api.quran.com/api/v4/chapter_recitations/7/${surahId}`);
                        const data = await response.json();
                        quranAudioPlayer.src = data.audio_file.audio_url;
                        currentSurahIndex = index;
                        quranAudioPlayer.play();
                    } catch (error) { console.error("Error fetching Surah audio:", error); }
                }
            }
        }
        quranAudioPlayer.onplay = () => {
            if (currentPlayingSurahElement) {
                currentPlayingSurahElement.classList.remove('playing');
                document.getElementById(`icon-${currentPlayingSurahElement.id.split('-')[2]}`).classList.replace('fa-pause', 'fa-play');
            }
            const surah = quranChapters[currentSurahIndex];
            currentPlayingSurahElement = document.getElementById(`surah-item-${surah.id}`);
            currentPlayingSurahElement.classList.add('playing');
            document.getElementById(`icon-${surah.id}`).classList.replace('fa-play', 'fa-pause');
            currentSurahName.textContent = `${surah.name_simple} (${surah.translated_name.name})`;
        };
        quranAudioPlayer.onpause = () => {
             if (currentPlayingSurahElement) {
                currentPlayingSurahElement.classList.remove('playing');
                document.getElementById(`icon-${currentPlayingSurahElement.id.split('-')[2]}`).classList.replace('fa-pause', 'fa-play');
             }
        };
        function playNextSurah() {
            if (currentSurahIndex !== -1 && currentSurahIndex < quranChapters.length - 1) {
                toggleSurahPlay(quranChapters[currentSurahIndex + 1].id, currentSurahIndex + 1);
            }
        }
        function incrementTasbeeh() { tasbeehCounterDisplay.textContent = ++tasbeehCount; saveTasbeehCount(); }
        function resetTasbeeh() { tasbeehCount = 0; tasbeehCounterDisplay.textContent = 0; saveTasbeehCount(); }
        function saveTasbeehCount() { localStorage.setItem('ramadanTasbeeh', tasbeehCount); }
        function loadTasbeehCount() { tasbeehCount = localStorage.getItem('ramadanTasbeeh') || 0; tasbeehCounterDisplay.textContent = tasbeehCount; }
        function setupRadioPlayer() { homeRadioAudioPlayer.src = radioStations[0].url; }
        function onYouTubeIframeAPIReady() {
            youtubePlayer = new YT.Player('youtube-player', {
                height: '480', width: '854',
                playerVars: { 'playsinline': 1, 'listType': 'playlist', 'list': 'PL6b_3Yr67_wFpDJfaZLlMEUP6h5EroJi2', 'controls': 0, 'rel': 0 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }
        function onPlayerStateChange(event) {
            document.getElementById('tv-play-button').classList.toggle('hidden', event.data === YT.PlayerState.PLAYING);
            document.getElementById('tv-pause-button').classList.toggle('hidden', event.data !== YT.PlayerState.PLAYING);
        }
        function playVideo() { youtubePlayer.playVideo(); }
        function pauseVideo() { youtubePlayer.pauseVideo(); }
        function nextVideo() { youtubePlayer.nextVideo(); }
        function previousVideo() { youtubePlayer.previousVideo(); }

        // --- Utility Functions ---
        function showTemporaryMessage(message) {
            const el = document.getElementById('settings-saved-message');
            el.textContent = message;
            el.classList.add('opacity-100');
            setTimeout(() => el.classList.remove('opacity-100'), 3000);
        }
        function formatTime(time24) {
            if (!time24) return '--:--';
            const [hour, minute] = time24.split(':');
            const h = parseInt(hour, 10);
            return `${padZero(h % 12 || 12)}:${minute} ${h >= 12 ? 'PM' : 'AM'}`;
        }
        function padZero(num) { return num < 10 ? '0' + num : String(num); }
    </script>
</body>
</html>